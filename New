static int stage = 0;
std::string msg;

if (stage == 0) {
    // Enable Runtime domain
    msg = build_command(send_counter++, "Runtime.enable");
} else if (stage == 1) {
    // Evaluate JS to get full HTML string
    json params = {
        {"expression", "document.documentElement.outerHTML"},
        {"returnByValue", true}
    };
    msg = build_command(send_counter++, "Runtime.evaluate", params);
} else {
    return -1;  // Done
}

stage++;












try {
    auto j = json::parse(received_payload);
    if (j.contains("result") && j["result"].contains("result") &&
        j["result"]["result"].contains("value")) {
        
        std::string html = j["result"]["result"]["value"];
        std::cout << "âœ… Full HTML:\n" << html << "\n";

        // Optional: You can index clickable elements here using regex or a parser.
        dom_received = true;
        lws_cancel_service(context);
    }
    received_payload.clear();
} catch (...) {
    // Waiting for more fragments
}
